---
- name: Add resilio apt key
  apt_key:
    url: https://linux-packages.resilio.com/resilio-sync/key.asc
    id: BE66CC4C3F171DE2


- name: Add resilio sync apt repository
  apt_repository:
    repo: deb https://linux-packages.resilio.com/resilio-sync/deb resilio-sync non-free
    update_cache: True


- name: Install resilio-sync
  package:
    name: resilio-sync
    state: latest


- name: Set up resilio-sync.service
  template:
    src: resilio/service.j2
    dest: /usr/lib/systemd/system/resilio-sync.service


- name: Configure resilio-sync
  template:
    src: resilio/configuration.j2
    dest: /etc/resilio-sync/config.json


- name: Create ~/Resilio
  file:
    state: directory
    path: "{{ item }}"
    owner: "{{ resilio.service.user }}"
    group: "{{ resilio.service.group }}"
  with_items:
    - "/home/{{ user.name }}/.rslsync"
    - "/home/{{ user.name }}/Resilio"


- name: Add user to resilio-sync group
  user:
    name: "{{ user.name }}"
    groups: "{{ resilio.service.group }}"
    append: True


- name: Restart resilio-sync
  systemd:
    name: resilio-sync
    state: restarted
    daemon_reload: True
    enabled: True
